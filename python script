import firebase_admin
from firebase_admin import credentials, db
import requests
import time
import random


# authenticate to firebase
cred = credentials.Certificate("credentials.json")
firebase_admin.initialize_app(cred, {"databaseURL": "https://ipsa-a67be-default-rtdb.firebaseio.com/"})


# creating reference to root node
ref = db.reference("/")


quotes = [
    "Save electricity today, for a brighter tomorrow. ЁЯТбЁЯМН",
    "Every watt saved is a step towards a sustainable future. тЪбЁЯМ▒",
    "Conserve electricity, empower the planet. ЁЯМНЁЯТк",
    "Be wise, energize! Save electricity, save money. ЁЯТ░ЁЯТб",
    "Switch off, power up! Save electricity and make a difference. тЪбЁЯМН",
    "Small changes, big impact. Save electricity, save the planet. ЁЯМНЁЯТб",
    "Choose to save electricity and embrace a greener lifestyle. ЁЯМ▒ЁЯТб",
    "Save electricity, save resources, save the world. ЁЯМНЁЯТбЁЯТк",
    "Energy conservation starts with you. Save electricity, save the future. ЁЯТбЁЯМНЁЯМ▒",
    "Make electricity conservation a habit and contribute to a sustainable world. ЁЯМНЁЯТбЁЯМ▒",
    "ЁЯТб рд╡рд┐рджреНрдпреБрддреН рд╕рдВрд╡рд░реНрдзрди рдХрд░реЛ, рдКрд░реНрдЬрд╛ рдХреЛ рдмрдЪрд╛рдУред тЪбя╕П",
    "ЁЯХпя╕П рджреАрдкрдХ рдмрдЪрд╛рдУ, рдмрд┐рдЬрд▓реА рдХреА рд╡реНрдпрд░реНрдерд╛ рдХреЛ рд░реЛрдХреЛред тЪбя╕П",
    "ЁЯФЛ рдКрд░реНрдЬрд╛ рдХреА рдЖрдкреВрд░реНрддрд┐ рдЫреЛрдЯреА рд╣реИ, рдЦрдкрдд рдШрдЯрд╛рдУ рдФрд░ рд╕рдВрд╡рд░реНрдзрди рдХрд░реЛред тЪбя╕П",
    "ЁЯТб рдмрд┐рдЬрд▓реА рдХреА рдмрдЪрдд рдХрд░реЗрдВ, рднрд╡рд┐рд╖реНрдп рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХрд░реЗрдВред тЪбя╕П",
    "ЁЯТб рдЖрдУ рд╡рд┐рджреНрдпреБрддреН рдХреА рд╕рдВрд░рдХреНрд╖рд╛ рдХрд░реЗрдВ, рд╣рд░ рдПрдХ рдмрд┐рдЬрд▓реА рдХреА рдХрдг рдХреЛ рдорд╣рддреНрд╡ рджреЗрдВред тЪбя╕П",
    "ЁЯТб рд╡рд┐рджреНрдпреБрддреН рдХреА рдмрдЪрдд рдзрд░реНрдо рд╣реИ, рдЗрд╕реЗ рдкрд╛рд▓рди рдХрд░реЛ рдФрд░ рдЖрдкрджрд╛ рд╕реЗ рдмрдЪрд╛рдУред тЪбя╕П",
    "ЁЯТкЁЯТб рд╡рд┐рджреНрдпреБрддреН рд╕рдВрд╡рд░реНрдзрди рд╕реЗ рд╣реЛрдЧрд╛ рджреЗрд╢ рдХрд╛ рд╡рд┐рдХрд╛рд╕, рд╣рдо рд╕рдмрдХреЛ рдорд┐рд▓рдХрд░ рдХрд░рдирд╛ рд╣реИ рдкреНрд░рдпрд╛рд╕ред тЪбя╕П",
    "ЁЯТб рдмрд┐рдЬрд▓реА рдХреА рдЫреЛрдбрд╝реЛ рд╡реНрдпрд░реНрде рдЦрдкрдд, рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦреЛ рдЖрдиреЗ рд╡рд╛рд▓реА рдкреАрдврд╝реА рдХреЗ рд▓рд┐рдП рдКрд░реНрдЬрд╛ рдмрдЪрд╛рддред тЪбя╕П",
    "ЁЯТб рд╡рд┐рджреНрдпреБрддреН рдХреА рдЬрд░реВрд░рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╣реА рдЦрдкрдд рдХрд░реЛ, рдзрд░рддреА рдХреА рд╕рдВрддрд╛рдиреЛрдВ рдХрд╛ рд╣реЛ рдзреНрдпрд╛рди рд╡рд┐рд╢реЗрд╖ рд░рдЦреЛред тЪбя╕П",
    "ЁЯТб рдмрд┐рдЬрд▓реА рд╕рдВрд░рдХреНрд╖рдг рд╣реА рд╣рдорд╛рд░рд╛ рд╕рд░реНрд╡реЛрдкрд░рд┐ рдХрд░реНрддрд╡реНрдп рд╣реИ, рдЕрдм рд╕рдордп рдЖрдпрд╛ рд╣реИ рдЗрд╕реЗ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХрд╛ред тЪбя╕П",
    ]


def MesageLimit():
    data = ref.get()  # Retrieve data from Firebase
    while True:
        # update operation (update existing value)
        db.reference("/").update({"Energy1":data["Energy1"]+5 })
        db.reference("/").update({"Energy2":data["Energy2"]+5 })
        db.reference("/").update({"Hub":data["Hub"]+10 })
        if(data["Energy1"] == Limit1-10):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}{}"'.format(data,"You are reaching your consuption limit for Room1")
                requests.get(base_url)
        if(data["Energy1"] == Limit1):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}{}"'.format(data,"You have reached your consuption limit for Room1")
                requests.get(base_url)
        if(data["Energy2"] == Limit2-10):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}{}"'.format(data,"You are reaching your consuption limit for Room2")
                requests.get(base_url)
        if(data["Energy2"] == Limit2):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}{}"'.format(data,"You have reached your consuption limit for Room2")
                requests.get(base_url)
        if(data["Hub"] == LimitHub-10):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}{}"'.format(data,"You are reaching your consuption limit for Hub")
                requests.get(base_url)
        if(data["Hub"] == LimitHub):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}{}"'.format(data,"You have reached your consuption limit for Hub")
                requests.get(base_url) 
        time.sleep(5)


def Mesage():
    while True:
        current_time = time.strftime("%H:%M:%S", time.localtime())
        if(current_time == "23:19:00"):
                data = ref.get()  # Retrieve data from Firebase
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{} at {} in {}"'.format(data,current_time,random.choice(quotes))
                requests.get(base_url)
        time.sleep(1)


def Alert():
    while True:
        data = ref.get()  # Retrieve data from Firebase
        # update operation (update existing value)
        db.reference("/").update({"Energy1":data["Energy1"]+5 })
        db.reference("/").update({"Energy2":data["Energy2"]+5 })
        db.reference("/").update({"Hub":data["Hub"]+10 })
        if(data["PIR_State1"] == data["SecurityMode1"] == 1):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}"'.format("Suspicious activity at Room1")
                requests.get(base_url)
        if(data["PIR_State2"] == data["SecurityMode2"] == 1):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}"'.format("Suspicious activity at Room2")
                requests.get(base_url)
        if(data["PIR_StateHub"] == data["SecurityModeHub"] == 1):
                base_url = 'https://api.telegram.org/bot5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ/sendMessage?chat_id=1021853106&text="{}"'.format("Suspicious activity at Hub")
                requests.get(base_url)
        time.sleep(5)



from telegram.ext import Updater, CommandHandler

def start(update, context):
    context.bot.send_message(chat_id=update.effective_chat.id, text="Welcome to the Bot")

def room1(update, context):
    data = ref.get()  # Retrieve data from Firebase
    category = data["Energy1"]
    response = f"Cosumption at Room 1 = {category}."
    context.bot.send_message(chat_id=update.effective_chat.id, text=response)
def room2(update, context):
    data = ref.get()  # Retrieve data from Firebase
    category = data["Energy2"]
    response = f"Cosumption at Room 2 = {category}."
    context.bot.send_message(chat_id=update.effective_chat.id, text=response)
def hub(update, context):
    data = ref.get()  # Retrieve data from Firebase
    category = data["Hub"]
    response = f"Cosumption at HUB = {category}."
    context.bot.send_message(chat_id=update.effective_chat.id, text=response)
        
# Set up the Telegram bot
TOKEN = "5690779760:AAGawGPDoh3EkV2Onqd0T9AowOOkdYhRAuQ"
updater = Updater(TOKEN, use_context=True)
dispatcher = updater.dispatcher

# Add the command handlers
dispatcher.add_handler(CommandHandler("start", start))
dispatcher.add_handler(CommandHandler("room1", room1))
dispatcher.add_handler(CommandHandler("room2", room2))
dispatcher.add_handler(CommandHandler("hub", hub))

# Start the bot
updater.start_polling()
updater.idle()



Mesage()

MesageLimit()

Alert()
